<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.webnest.mapper.SearchMapper">

    <!--    승찬 기생중 -->
    <select id="selectByQuery" resultType="UserVO" parameterType="String">
        SELECT ID, USER_NAME, USER_BIRTHDAY, USER_EMAIL, USER_PHONE, USER_AGE, USER_EXP, USER_LEVEL, USER_THUMBNAIL_NAME, USER_THUMBNAIL_URL, USER_NICKNAME, USER_PASSWORD
        FROM TBL_USER
        WHERE USER_NICKNAME LIKE '%'||#{query}||'%'
    </select>
    <select id="selectQuestionPostQByQuery" resultType="PostSearchDTO" parameterType="String">
        SELECT TBP.ID, TBP.POST_TITLE, TBP.POST_CONTENT,
            TBP.POST_CREATE_AT, TBP.POST_VIEW_COUNT, TBP.POST_TYPE, TBP.USER_ID,
            TBU.USER_LEVEL, TBU.USER_THUMBNAIL_URL, TBU.USER_NICKNAME,
            COUNT(TBC.ID) AS COMMENT_COUNT
        FROM (
            SELECT ID, POST_TITLE, POST_CONTENT, POST_CREATE_AT, POST_VIEW_COUNT,
            POST_TYPE, USER_ID FROM TBL_POST
            WHERE POST_TYPE = 'JS' OR POST_TYPE = 'JAVA' OR POST_TYPE = 'ORACLE'
        ) TBP
        JOIN TBL_USER TBU
        ON TBP.USER_ID = TBU.ID
        LEFT JOIN TBL_COMMENT TBC
        ON TBP.ID = TBC.POST_ID
        GROUP BY TBP.ID, TBP.POST_TITLE, TBP.POST_CONTENT, TBP.POST_CREATE_AT,
        TBP.POST_VIEW_COUNT, TBP.POST_TYPE, TBP.USER_ID, TBU.USER_NICKNAME,
        TBU.USER_LEVEL, TBU.USER_THUMBNAIL_URL
        HAVING TBP.POST_CONTENT LIKE '%'||#{query}||'%'
        OR TBP.POST_TITLE LIKE '%'||#{query}||'%'
        ORDER BY TBP.ID
    </select>
    <select id="selectOpenPostQByQuery" resultType="PostSearchDTO" parameterType="String">
        SELECT TBP.ID, TBP.POST_TITLE, TBP.POST_CONTENT,
            TBP.POST_CREATE_AT AS "POST", TBP.POST_VIEW_COUNT, TBP.POST_TYPE, TBP.USER_ID,
            TBU.USER_LEVEL, TBU.USER_THUMBNAIL_URL, TBU.USER_NICKNAME,
            COUNT(TBC.ID) AS COMMENT_COUNT
        FROM (
            SELECT ID, POST_TITLE, POST_CONTENT, POST_CREATE_AT, POST_VIEW_COUNT,
            POST_TYPE, USER_ID FROM TBL_POST WHERE POST_TYPE = 'OPEN'
        ) TBP
        JOIN TBL_USER TBU
        ON TBP.USER_ID = TBU.ID
        LEFT JOIN TBL_COMMENT TBC
        ON TBP.ID = TBC.POST_ID
        GROUP BY TBP.ID, TBP.POST_TITLE, TBP.POST_CONTENT, TBP.POST_CREATE_AT,
            TBP.POST_VIEW_COUNT, TBP.POST_TYPE, TBP.USER_ID, TBU.USER_NICKNAME,
            TBU.USER_LEVEL, TBU.USER_THUMBNAIL_URL
        HAVING TBP.POST_CONTENT LIKE '%'||#{query}||'%'
        OR TBP.POST_TITLE LIKE '%'||#{query}||'%' ORDER BY TBP.ID
    </select>
    <select id="selectQuizByQuery" resultType="QuizVO" parameterType="String">
        SELECT ID, QUIZ_TITLE, QUIZ_DESCRIPTION, QUIZ_CATEGORY, QUIZ_EXPECTATION, QUIZ_EXP, QUIZ_DIFFICULT, QUIZ_LANGUAGE
        FROM TBL_QUIZ
        WHERE QUIZ_TITLE LIKE '%'||#{query}||'%' OR QUIZ_DESCRIPTION LIKE '%'||#{query}||'%'
            OR QUIZ_CATEGORY LIKE '%'||#{query}||'%' OR QUIZ_EXPECTATION LIKE '%'||#{query}||'%'
            OR QUIZ_DIFFICULT LIKE '%'||#{query}||'%' OR QUIZ_LANGUAGE LIKE '%'||#{query}||'%'
    </select>

    <!--    승찬 기생중 -->
</mapper>